--月/日來看每天交易量
with txn_month as (
select
EXTRACT(month FROM SI.REQ_TIMESTAMP) AS month,
COUNT(1) AS CNT
from ods_tw.tb_service_interchange@ODS si
where si.req_timestamp
BETWEEN TO_TIMESTAMP('2021/01/01 00:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/08/01 00:00:00 ','YYYY/MM/DD HH24:MI:SS')
GROUP BY EXTRACT(month FROM SI.REQ_TIMESTAMP)
ORDER BY month
),txn_day as (
select
EXTRACT(day FROM SI.REQ_TIMESTAMP) AS day,
COUNT(1) AS CNT
from ods_tw.tb_service_interchange@ODS si
where si.req_timestamp
BETWEEN TO_TIMESTAMP('2021/7/5 00:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/7/6 00:00:00 ','YYYY/MM/DD HH24:MI:SS')
GROUP BY EXTRACT(day FROM SI.REQ_TIMESTAMP)
ORDER BY day
)
select
*
from txn_day
--where cnt = (select max(cnt) from txn_8)
;

--月來看每天交易量 並Rank排名
select
EXTRACT(DAY FROM SI.REQ_TIMESTAMP) AS DAY,
COUNT(1) AS CNT,
RANK () OVER ( ORDER BY COUNT(1) desc) RANK
from ods_tw.tb_service_interchange@ODS si
where si.req_timestamp
BETWEEN TO_TIMESTAMP('2021/08/01 00:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/09/01 00:00:00 ','YYYY/MM/DD HH24:MI:SS')
GROUP BY EXTRACT(DAY FROM SI.REQ_TIMESTAMP)
ORDER BY RANK;

--天來看每小時交易量並Rank排名
select
EXTRACT(hour FROM SI.REQ_TIMESTAMP) AS hour,
COUNT(1) AS CNT,
RANK () OVER ( ORDER BY COUNT(1) desc) RANK
from cifx.tb_service_interchange si
where si.req_timestamp
BETWEEN TO_TIMESTAMP('2021/06/25 00:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 00:00:00 ','YYYY/MM/DD HH24:MI:SS')
GROUP BY EXTRACT(hour FROM SI.REQ_TIMESTAMP)
--ORDER BY RANK
order by hour asc
;

--每小時建檔數 較好看但 語法多
WITH TXN_DATA AS (
SELECT
TXN_CODE,
RESULT_CODE
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN TO_TIMESTAMP('2021/06/25 00:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 00:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
),
TXN_SUCCESS_0800_0900 AS (
SELECT
'0800-0900' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 08:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 09:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),
TXN_SUCCESS_0900_1000 AS (
SELECT
'0900-1000' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 09:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 10:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),TXN_SUCCESS_1000_1100 AS (
SELECT
'1000-1100' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 10:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 11:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),TXN_SUCCESS_1100_1200 AS(
SELECT
'1100-1200' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 11:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 12:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),TXN_SUCCESS_1200_1300 AS (
SELECT
'1200-1300' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 12:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 13:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),TXN_SUCCESS_1300_1400 AS (
SELECT
'1300-1400' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 13:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 14:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),TXN_SUCCESS_1500_1600 AS (
SELECT
'1500-1600' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 15:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 16:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),TXN_SUCCESS_1600_1700 AS (
SELECT
'1600-1700' AS TIME_INTERVAL,
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 16:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 17:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
),TXN_SUCCESS_1700_1800 AS (
SELECT
'1700-1800' AS TIME_INTERVA17
COUNT(1)
FROM CIFX.TB_SERVICE_INTERCHANGE SI
WHERE SI.REQ_TIMESTAMP BETWEEN
TO_TIMESTAMP('2021/06/25 17:00:00','YYYY/MM/DD HH24:MI:SS')
AND TO_TIMESTAMP('2021/06/26 18:00:00 ','YYYY/MM/DD HH24:MI:SS')
AND OUTTER_TRADE_ATTR3 IS NOT NULL
AND OUTTER_TRADE_ATTR3 <> '3'
AND RESULT_CODE = '0000'
)
SELECT * FROM TXN_SUCCESS_0800_0900 UNION
SELECT * FROM TXN_SUCCESS_0900_1000 UNION
SELECT * FROM TXN_SUCCESS_1000_1100 UNION
SELECT * FROM TXN_SUCCESS_1100_1200 UNION
SELECT * FROM TXN_SUCCESS_1200_1300 UNION
SELECT * FROM TXN_SUCCESS_1300_1400 UNION
SELECT * FROM TXN_SUCCESS_1500_1600 UNION
SELECT * FROM TXN_SUCCESS_1600_1700 UNION
SELECT * FROM TXN_SUCCESS_1700_1800
--ORDER BY SI.REQ_TIMESTAMP DESC
;